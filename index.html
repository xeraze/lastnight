<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Последний Вечер</title>
    <script src="https://cdn.jsdelivr.net/npm/tone@14.9.15/build/Tone.min.js"></script>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #000;
            font-family: 'Courier New', Courier, monospace;
            color: #fff;
        }
        #gameCanvas {
            border: 2px solid #555;
            background-color: #333;
            width: 1280px; 
            height: 720px;
            max-width: 100vw;
            max-height: 100vh;
            cursor: default;
        }
        #dialogBox {
            width: 1280px;
            max-width: 90%;
            height: 120px;
            background-color: #111;
            border: 2px solid #555;
            margin-top: 20px;
            padding: 15px;
            box-sizing: border-box;
            color: #eee;
            font-size: 18px;
            position: relative;
        }
        #dialogBox button {
            position: absolute;
            bottom: 10px;
            right: 15px;
            background: #444;
            color: #fff;
            border: 1px solid #777;
            padding: 5px 10px;
            cursor: pointer;
            transition: background 0.2s;
        }
        #dialogBox button:hover {
            background: #666;
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas" width="1280" height="720"></canvas>
    <div id="dialogBox">
        <span id="dialogText">Нажмите W, A, S, D, чтобы начать движение и запустить музыку.</span>
        <button id="dialogButton" style="display: none;">Продолжить</button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        const WIDTH = canvas.width;
        const HEIGHT = canvas.height;

        const ROOM_COLOR = '#666';
        const WALL_COLOR = '#444';
        
        const ROOM_RECT = { x: 50, y: 50, w: WIDTH - 100, h: HEIGHT - 180 }; 
        const PLAYER_RADIUS = 15;
        
        const WINDOW_RECT = { x: WIDTH / 2 - 150, y: 50, w: 300, h: 100, color: '#363640' };
        
        const FURNITURE = [
            { x: 300, y: 450, w: 200, h: 100, color: '#8B4513' },
            { x: 250, y: 550, w: 50, h: 50, color: '#A0522D' },
            { x: ROOM_RECT.x + 10, y: ROOM_RECT.y + 10, w: 70, h: 180, color: '#C0C0C0' },
            { x: ROOM_RECT.x + 100, y: ROOM_RECT.y + 10, w: 60, h: 100, color: '#222' },
            { x: WIDTH - 150, y: ROOM_RECT.y + 100, w: 20, h: 150, color: '#5C3317', isDoor: true }
        ];

        let player = {
            x: WIDTH / 2,
            y: HEIGHT / 2,
            speed: 5,
            color: '#39ff14'
        };

        const keysPressed = {};
        
        window.addEventListener('keydown', (e) => {
            keysPressed[e.key.toLowerCase()] = true;
            if (!musicStarted) startMusic();
        });
        
        window.addEventListener('keyup', (e) => {
            keysPressed[e.key.toLowerCase()] = false;
        });

        const SNOW_PARTICLES = [];
        const MAX_PARTICLES = 100;

        function createSnow() {
            for (let i = 0; i < MAX_PARTICLES; i++) {
                SNOW_PARTICLES.push({
                    x: WINDOW_RECT.x + Math.random() * WINDOW_RECT.w,
                    y: WINDOW_RECT.y + Math.random() * WINDOW_RECT.h,
                    radius: Math.random() * 2 + 0.5,
                    speedY: Math.random() * 2 + 1,
                    speedX: (Math.random() - 0.5) * 0.5
                });
            }
        }
        
        function updateSnow() {
            ctx.save();
            ctx.beginPath();
            ctx.rect(WINDOW_RECT.x, WINDOW_RECT.y, WINDOW_RECT.w, WINDOW_RECT.h);
            ctx.clip(); 

            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            
            for (let i = 0; i < MAX_PARTICLES; i++) {
                let p = SNOW_PARTICLES[i];

                p.y += p.speedY;
                p.x += p.speedX;

                if (p.y > WINDOW_RECT.y + WINDOW_RECT.h) {
                    p.y = WINDOW_RECT.y;
                    p.x = WINDOW_RECT.x + Math.random() * WINDOW_RECT.w;
                }

                ctx.beginPath();
                ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                ctx.fill();
            }

            ctx.restore();
        }
        
        let musicStarted = false;
        let ambientSynth;
        
        function setupAudio() {
            ambientSynth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "sine" },
                envelope: { attack: 2, decay: 0.5, sustain: 0.8, release: 4 },
                volume: -15
            }).toDestination();
        }

        function startMusic() {
            if (musicStarted) return;
            Tone.start();
            
            const melody = new Tone.Sequence((time, note) => {
                ambientSynth.triggerAttackRelease(note, "2m", time);
            }, ["C4", ["E4", "G3"], "A3", ["F3", "C4"]], "4n");
            
            melody.loop = true;
            melody.start(0);
            Tone.Transport.start();
            musicStarted = true;
        }
        
        let isMoving = false;
        let lastStepTime = 0;
        const stepInterval = 200; 
        
        function playStepSound() {
            const now = Date.now();
            if (now > lastStepTime + stepInterval) {
                const noise = new Tone.NoiseSynth({
                    noise: { type: 'pink' },
                    envelope: { attack: 0.001, decay: 0.05 }
                }).toDestination();
                noise.triggerAttackRelease("16n", Tone.now());
                noise.volume.value = -10;
                lastStepTime = now;
            }
        }
        
        function updatePlayer() {
            let dx = 0;
            let dy = 0;

            if (keysPressed['w']) dy -= 1;
            if (keysPressed['s']) dy += 1;
            if (keysPressed['a']) dx -= 1;
            if (keysPressed['d']) dx += 1;
            
            isMoving = (dx !== 0 || dy !== 0);

            let moveX = dx * player.speed;
            let moveY = dy * player.speed;

            if (dx !== 0 && dy !== 0) {
                const diagSpeed = player.speed * 0.707;
                moveX = dx > 0 ? diagSpeed : (dx < 0 ? -diagSpeed : 0);
                moveY = dy > 0 ? diagSpeed : (dy < 0 ? -diagSpeed : 0);
            }
            
            if (isMoving) {
                playStepSound();
                
                const newX = player.x + moveX;
                const newY = player.y + moveY;
                let collided = false;

                if (newX - PLAYER_RADIUS < ROOM_RECT.x || 
                    newX + PLAYER_RADIUS > ROOM_RECT.x + ROOM_RECT.w ||
                    newY - PLAYER_RADIUS < ROOM_RECT.y ||
                    newY + PLAYER_RADIUS > ROOM_RECT.y + ROOM_RECT.h) {
                    collided = true;
                }

                for (const obj of FURNITURE) {
                    if (newX + PLAYER_RADIUS > obj.x && newX - PLAYER_RADIUS < obj.x + obj.w &&
                        newY + PLAYER_RADIUS > obj.y && newY - PLAYER_RADIUS < obj.y + obj.h) {
                        collided = true;
                        
                        if (obj.isDoor) {
                             document.getElementById('dialogText').textContent = "Дверь заперта. Нужно найти ключ.";
                        }
                        break;
                    }
                }

                if (!collided) {
                    player.x = newX;
                    player.y = newY;
                }
            }
        }
        
        function drawRoom() {
            ctx.fillStyle = WALL_COLOR;
            ctx.fillRect(0, 0, WIDTH, HEIGHT);

            ctx.fillStyle = ROOM_COLOR;
            ctx.fillRect(ROOM_RECT.x, ROOM_RECT.y, ROOM_RECT.w, ROOM_RECT.h);

            ctx.fillStyle = WINDOW_RECT.color;
            ctx.fillRect(WINDOW_RECT.x, WINDOW_RECT.y, WINDOW_RECT.w, WINDOW_RECT.h);
            
            ctx.strokeStyle = '#222';
            ctx.lineWidth = 4;
            ctx.strokeRect(WINDOW_RECT.x, WINDOW_RECT.y, WINDOW_RECT.w, WINDOW_RECT.h);
        }

        function drawFurniture() {
            for (const obj of FURNITURE) {
                ctx.fillStyle = obj.color;
                ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
                
                if (obj.isDoor) {
                    ctx.fillStyle = '#111';
                    ctx.fillRect(obj.x + 5, obj.y + 70, 10, 5);
                }
                
                if (obj.color === '#C0C0C0') {
                    ctx.fillStyle = '#E0E0E0';
                    ctx.fillRect(obj.x + obj.w - 10, obj.y + 10, 5, 20);
                }
            }
        }
        
        function drawPlayer() {
            ctx.fillStyle = player.color;
            ctx.beginPath();
            ctx.arc(player.x, player.y, PLAYER_RADIUS, 0, Math.PI * 2);
            ctx.fill();
        }

        function gameLoop() {

            ctx.clearRect(0, 0, WIDTH, HEIGHT);
            
            drawRoom();
            
            updateSnow();
            
            drawFurniture();
            
            updatePlayer();
            drawPlayer();
            
            requestAnimationFrame(gameLoop);
        }

        window.onload = function() {
            setupAudio();
            createSnow();
            gameLoop();
            
            document.getElementById('dialogText').textContent = "Тишина. Вы сидите за столом, доедая печенье. За окном идет снег. Вы чувствуете себя расслабленно и спокойно.";
        };
    </script>
</body>
</html>
